Kidroid - poor man's KiCad automation
=====================================


Introduction
------------

Kidroid is a simple script used to automate production of some artefacts for your KiCad board. More specifically, it
can be used to generate the following:
- fabrication bundle, containing gerber and drill files;
- documentation bundle, contianing schematics, layer drawings and interactive BOM.

Currently, only MacOS is supported, although it should be easy to port it to other *nix platforms.

Kidroid is purposely simple with a very restricted feature set. If it does not suit your needs, I would recommend
looking at far better solutions, such as [Kibot|https://github.com/INTI-CMNB/KiBot].



Rationale
---------

Kidroid was developed as an alternative to Kibot, specifically for my use case. More specifically, I had been 
successfully using Kibot for many months, but when I upgraded KiCad to version 7, Kibot did not work anymore
in my setup. I can only guess some time was to be required for Kibot to properly support KiCad 7. Anyway, since I
needed to produce some artefacts, I decided to script the production of those, using the new KiCad 7 CLI.

As a benefit, since the solution is quite simple, it has the following benefits:
- the integration with KiCad is very loose (I believe), so that it should be more resilient to future changes in
  KiCad
- it has very little dependencies to external tools and libraries, and in particular, does not rely on deploying
  python dependencies inside the KiCad python environment.


Deployment
----------

Just put the script directory somewhere, including sub-folders. Be sure to checkout the git submodule for
InteractiveHtmlBom.

Apart from the usual Posix commands, the script needs the following dependencies:
- jq
- zip
- kicad 7 or above (obviously)


Usage
-----

### General

Kidroid must be invoked on a specific KiCad project, by locating the main .kicad_pro file. The schematics and PCB
files will be deduced from there, and fed to kicad to generate the artefacts.

Fabrication artefacts will be placed in a dedicated sub-directory inside the project's parent directory. Similarly,
documentation artefacts will be placed in a dedicated sub-directory. The zip bundles, if any, will be put in the
project's parent directory.

In order to avoid any possible problem, the sub-directories for fabrication and documentation artefacts must not exist
prior to invocation of kidroid.


### Command-line

A number of command-line options are provided to control the outputs generated by the tool. 

The following options define which project to use:

    --project-dir <directory>  Will look for a single .kicad_pro file in the given directory
    --project-file <file>      Path to the .kicad_pro file

By default, kidroid will try to find the project file in the current directory.

The following switches are used to define _what_ to produce; adding `=no` to the switch disable the corresponding items.

    --doc-sch         schematics documentation artefact
    --doc-drill-map   drill map; not applicable when the drill fabrication artefact is not generated.
    --doc-layers      PDF drawings of each layer for documentation purposes
    --doc-ibom        Interactive HTML Bom  
    --doc-plot <plot_specification>  A PDF plot of one or more layers; multiple plots can be specified by repeating
                                     the option. plot_specification looks as follows:
                                     <name>:<layer>[,<layer>..]

The fabrication and documentation artefacts can also be enabled/disabled globally as follows:

    --fab          generate fabrication artefacts as well as bundle if applicable
    --fab=no       disable generation of all fabrication artefacts
    --doc          generate documentation-related artefacts as well as bundle if applicable
    --doc=no       disable generation of all documentation-related artefacts
    --fab-zip/--fab-zip=no  create (or not) a zip bundle with all fabication-related artefacs; not applicable when no
                            fabrication artefact is generated
    --doc-zip/--doc-zip=no  create (or not) a zip bundle with all documentation-related artefacs; not applicable when no
                            documentation artefact is produced

The name of the various items that get generated can be controls by specifying patterns, as follows:

    --pattern-fab-dir <dir_pattern>      sub-directory containing all fabrication artefacts
    --pattern-fab-zip <file_pattern>     zip bundle with fabrication artefacts
    --pattern-fab-gerber <file_pattern>  
    --pattern-fab-drill <file_pattern>

    --pattern-doc-dir <dir_pattern>      sub-directory containing all documentation artefacts
    --pattern-doc-zip <file_pattern>     zip bundle with documentation artefacts
    --pattern-doc-sch <file_pattern>     Schematics drawing documentation artefact
    --pattern-doc-drill <file_pattern>   Drill map documentation artefact
    --pattern-doc-layers <file_pattern>  PDF layer drawings documentation artefacts
    --pattern-doc-ibom <file_pattern>    Interactive HTML bom documentation artefact

Worth noting:

    --var-revision <variable_name>  name of the KiCad project's text variable containing the revision value, for use
                                    with the {r} placeholder in pattern


### Patterns

Patterns are simple strings containing placeholders, which will be replaced by the corresponding items based on
the project context and the artefact considered. The placeholders are as follows:

    {PD}: Project directory
    {P}:  Project name
    {r}:  Project revision
    {t}:  Artefact type
    {i}:  Artefact ID (actual meaning depends on artefact type, may be empty)
    {x}:  Suitable etension for artefact


### Wrapping it up

A nice way to invoke kidroid is to wrap it up in a makefile, enabling you to put the necessary command-line options,
and possibly clean the directories from previous runs. Here's an example from my setup:

    kidroid:
            rm -Rf *_rev*_Doc/ *_rev*_Fab/
            rm -f *_rev*_Doc.zip *_rev*_Fab.zip
            ~/Documents/KiCad/Tools/kidroid/kidroid --fab --doc-sch --doc-layers --doc-ibom --doc-drill-map \
                    --doc-plot physical:Dwgs.User,Edge.Cuts,F.CrtYd,F.Mask


FAQs
----

- Why didn't you simply update Kibot to be compatible with KiCad 7?
   - Because I needed to have a solution within 48h, but most probably I could never have been able to sort out Kibot
     in such a timeframe. I then decided it might be useful to package this "solution" neatly for others who might
     need it.
     
- Why didn't you implement it in Python?
   - Because, given the feature set I envisioned, it seemed to me that using shell scripts would be the best tool for
     the job. Additionally, using plain scripts means very few dependencies, and no need to deal with the Kicad's pip
     matter, which is not nicely solved on MacOs.
     
- Why didn't you implement it in Powershell?
   - Are you nuts? :-) Joke aside, PowerShell is not part of my set of hammers, and I needed to see this problem as a
     nail.
  